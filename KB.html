<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knowledge Base</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Knowledge Base</h1>

  <div class="controls">
    <input type="text" id="search" placeholder="Search topic">
    <button onclick="filterData()">Search</button>
    <button onclick="resetData()">Reset</button>
    <button onclick="downloadFiltered('xlsx')">Download Excel</button>
    <button onclick="downloadFiltered('csv')">Download CSV</button>
  </div>

  <table id="results">
    <thead>
      <tr>
        <th onclick="sortTable('Title')">Title</th>
        <th onclick="sortTable('Notes')">Notes</th>
        <th onclick="sortTable('Tags')">Tags</th>
        <th onclick="sortTable('URL')">URL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let kb = [];
    let filteredData = [];
    let sortDirection = 1;
    let currentSortColumn = '';

    async function loadExcelData() {
      const response = await fetch('knowledge_data.xlsx');
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      let combined = [];

      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        rows.forEach(row => {
          combined.push({
            Title: row.Title || row.title || '',
            Notes: row.Notes || row.Note || row.notes || '',
            Tags: row.Tags || row.Tag || '',
            URL: row.URL || row.Link || ''
          });
        });
      });

      kb = combined;
      restoreSettings();
    }

    function displayResults(data) {
      const body = document.querySelector('#results tbody');
      body.innerHTML = data.map(d =>
        `<tr>
          <td>${d.Title}</td>
          <td>${d.Notes}</td>
          <td>${d.Tags}</td>
          <td>${d.URL ? `<a href="${d.URL}" target="_blank">${d.URL}</a>` : ''}</td>
        </tr>`
      ).join('');
      filteredData = data;
    }

    function filterData() {
      const query = document.getElementById('search').value.toLowerCase();
      localStorage.setItem('kb_search', query);

      const filtered = kb.filter(d =>
        d.Title.toLowerCase().includes(query) ||
        d.Notes.toLowerCase().includes(query) ||
        d.Tags.toLowerCase().includes(query) ||
        d.URL.toLowerCase().includes(query)
      );
      displayResults(filtered);
    }

    function resetData() {
      document.getElementById('search').value = '';
      localStorage.removeItem('kb_search');
      displayResults(kb);
    }

    function sortTable(column) {
      if (currentSortColumn === column) {
        sortDirection *= -1;
      } else {
        currentSortColumn = column;
        sortDirection = 1;
      }

      localStorage.setItem('kb_sort_column', column);
      localStorage.setItem('kb_sort_direction', sortDirection);

      const sorted = [...filteredData].sort((a, b) => {
        const valA = a[column].toLowerCase();
        const valB = b[column].toLowerCase();
        if (valA < valB) return -1 * sortDirection;
        if (valA > valB) return 1 * sortDirection;
        return 0;
      });

      displayResults(sorted);
    }

    function restoreSettings() {
      const savedSearch = localStorage.getItem('kb_search');
      const savedColumn = localStorage.getItem('kb_sort_column');
      const savedDirection = parseInt(localStorage.getItem('kb_sort_direction')) || 1;

      if (savedSearch) document.getElementById('search').value = savedSearch;

      displayResults(kb);

      if (savedSearch) filterData();
      if (savedColumn) {
        sortDirection = savedDirection;
        currentSortColumn = savedColumn;
        sortTable(savedColumn);
      }
    }

    function getTimestamp() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}_${hours}${minutes}`;
    }

    function downloadFiltered(format) {
      if (!filteredData.length) {
        alert('No data to download.');
        return;
      }

      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Filtered_Results');
      const timestamp = getTimestamp();

      if (format === 'csv') {
        XLSX.writeFile(wb, `KnowledgeBase_Results_${timestamp}.csv`, { bookType: 'csv' });
      } else {
        XLSX.writeFile(wb, `KnowledgeBase_Results_${timestamp}.xlsx`);
      }
    }

    loadExcelData();
  </script>
</body>
</html>
